---
title: " Oracle soils Burkina Faso t = 0 (#6) "
author: "Frédéric Mahé"
date: '`r format(Sys.time(), "%d %B %Y")`'

output:
  rmarkdown::html_document:
    theme: lumen
    toc: yes
    toc_float: TRUE
    keep_md: yes
    # code_folding: hide
---

```{r setup, include=FALSE}
rm(list = ls()) # remove all the object before starting
knitr::opts_chunk$set(echo = TRUE)
```

***

#### load required packages

```{r packages, message=FALSE}
library(here)
library(tidyverse)
library(vegan)
library(hilldiv)
```


# SSU rRNA metabarcoding (16S V3-V4)

## preamble

### variables and functions

```{r}
input <- "Oracle_soils_16S_341F_785R_87_samples.OTU.filtered.cleaved.nosubstringOTUs.mumu.table3"
useful_metadata <- c("OTU", "total", "amplicon", "length", "abundance",
                     "spread", "identity", "taxonomy", "references")
```

```{r}
load_clean_16S_occurrence_data <- function(filename){
    here::here("data", "MetaB_t0", filename) %>%
        read_tsv(show_col_types = FALSE)
}
```

### load data

```{r}
load_clean_16S_occurrence_data(input) -> full_occurrence_table

```


## alpha diversity

### estimate usual diversity index

extract only occurrences and transpose for vegan

```{r}
full_occurrence_table %>%
    select(-all_of(useful_metadata)) %>%
    t() -> occurrences_t
```

compute usual indices

```{r}
## estimated richness
vegan::estimateR(round(occurrences_t)) -> R

## Shannon index H; richness + evenness
vegan::diversity(occurrences_t, index = "shannon") -> H

## Simpson's D index; richness + evenness; 0-1; 1 - D rises as evenness increases
vegan::diversity(occurrences_t, index = "invsimpson") -> inv_D

## species richness
vegan::specnumber(occurrences_t) -> S

## Pielou’s index of evenness; 0-1, 1 = max. evenness
H / log(S) -> J

## clean up
rm(occurrences_t, S)
```

### Hill numbers: estimate effective number of species

This equation has a parameter `q` that defines its sensitivity to rare species:
low values of `q` favor rare species, high values of `q` favor abundant species. 

For example, Shannon diversity is of order `q = 1`, and for Simpson
diversity `q = 2`. When `q = 0`, diversity = `S` (richness), because
rare species are treated the same as abundant ones.

```{r}
compute_hill_numbers <- function(qvalue){
    full_occurrence_table %>%
        select(-all_of(useful_metadata)) %>%
        hill_div(qvalue = qvalue)
}
```

Hill numbers:
- richness (`qvalue = 0`, `dR`),
- richness + evenness (Shannon diversity) favor rare species (`qvalue = 1`, `dREr`),
- richness + evenness (inverse Simpson = Simpson diversity) favor abundant species(`qvalue = 1`, `dREa`)


```{r}
## richness
compute_hill_numbers(qvalue = 0) -> dR

## Shannon diversity
compute_hill_numbers(qvalue = 1) -> dREr

## Simpson diversity
compute_hill_numbers(qvalue = 2) -> dREa

## Shannon evenness
dREr / dR -> eDRr

## Simpson evenness
dREa / dR -> eDRa

## clean up
rm(full_occurrence_table, compute_hill_numbers)
```


### pool diversity indices

vegan's estimated richness (R) is more complex and needs to be
transformed first. Other indices are vectors and can used directly
to build a new tibble.

```{r}
R %>%
    t() %>%
    as_tibble(rownames = "soil_code") -> estimated_richness

tibble(estimated_richness,
       Shannon = H,
       Inv_Simpson = inv_D,
       Pielou = J,
       Hill_Richness = dR,
       Hill_Shannon = dREr,
       Hill_Inv_Simpson = dREa,
       Hill_Shannon_evenness = eDRr,
       Hill_Simpson_evenness = eDRa) -> Indices_bact

## clean up
rm(R, H, inv_D, J, dR, dREr, dREa, eDRr, eDRa, estimated_richness)
```


***

```{r}
sessionInfo()
rm(list = ls())
```
